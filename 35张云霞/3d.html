<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="https://cesiumjs.org/releases/1.57/Build/Cesium/Cesium.js"></script>
		<link href="https://cesiumjs.org/releases/1.57/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
		<title></title>
		<style>
			#cesiumContainer{
				width: 100%;
				height: 100%;
				overflow: hidden;
				position: absolute;
			}
			#toolbar{
				color: white;
				width: 20%;
				height: 100%;
				position: relative;
				float: left;
				background-color: rgba(0,0,0,0.3);
			}
		</style>
	</head>
	<body>
		<div id="cesiumContainer" class="fullSize"></div>
		<div id="toolbar">
			<table class="infoPanel">
				<tbody>
					<tr>
						<td>单击3D窗口，使用键盘更改飞机设置</td>
					</tr>
					<tr>
						<td>航向: <span id="heading"></span>°</td>
					</tr>
					<tr>
						<td>← 向左/→ 向右</td>
					</tr>
					<tr>
						<td>倾斜: <span id="pitch"></span>°</td>
					</tr>
					<tr>
						<td>↑ 向上/↓ 向下</td>
					</tr>
					<tr>
						<td>自然上旋: <span id="roll"></span>°</td>
					</tr>
					<tr>
						<td>← + ⇧ 左旋/→ + ⇧ 右旋</td>
					</tr>
					<tr>
						<td>速度: <span id="speed"></span>m/s</td>
					</tr>
					<tr>
						<td>↑ + ⇧ 加速/↓ + ⇧ 减速</td>
					</tr>
					<tr>
						<td>依照航空器飞行
							<input id="fromBehind" type="checkbox">
						</td>
					</tr>

				</tbody>
			</table>
		</div>
		
		<script>
			var viewer = new Cesium.Viewer('cesiumContainer', {
				// terrainProvider: Cesium.createWorldTerrain(),
				shouldAnimate: true
			});

			var canvas = viewer.canvas;
			canvas.setAttribute('tabindex', '0'); 
			//为canvas设置focus
			canvas.addEventListener('click', function() {
				canvas.focus();
			});
			canvas.focus();

			var scene = viewer.scene;

			//位置
			var pathPosition = new Cesium.SampledPositionProperty();
			//路径
			var entityPath = viewer.entities.add({
				position: pathPosition,
				name: 'path',
				path: {
					show: true,
					leadTime: 0,
					trailTime: 60,
					width: 10,
					resolution: 1,
					material: new Cesium.PolylineGlowMaterialProperty({
						glowPower: 0.3,
						taperPower: 0.3,
						color: Cesium.Color.PALEGOLDENROD
					})
				}
			});

			var camera = viewer.camera;
			var controller = scene.screenSpaceCameraController;
			var r = 0;
			var center = new Cesium.Cartesian3();

			var hpRoll = new Cesium.HeadingPitchRoll();
			var hpRange = new Cesium.HeadingPitchRange();
			var speed = 10;
			//将角度转换为弧度
			var deltaRadians = Cesium.Math.toRadians(3.0);

			var position = Cesium.Cartesian3.fromDegrees(114.311, 30.558, 5000.0);
			var speedVector = new Cesium.Cartesian3();
			var fixedFrameTransform = Cesium.Transforms.localFrameToFixedFrameGenerator('north', 'west');

			//飞机模型
			var planePrimitive = scene.primitives.add(Cesium.Model.fromGltf({
				url: 'CesiumAir/Cesium_Air.glb',
				modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(position, hpRoll, Cesium.Ellipsoid.WGS84,
					fixedFrameTransform),
				minimumPixelSize: 128
			}));

			planePrimitive.readyPromise.then(function(model) {
				//以半速播放并循环所有动画
				model.activeAnimations.addAll({
					multiplier: 0.5,
					loop: Cesium.ModelAnimationLoop.REPEAT
				});

				// 缩放模型
				r = 2.0 * Math.max(model.boundingSphere.radius, camera.frustum.near);
				controller.minimumZoomDistance = r * 0.5;
				Cesium.Matrix4.multiplyByPoint(model.modelMatrix, model.boundingSphere.center, center);
				var heading = Cesium.Math.toRadians(230.0);
				var pitch = Cesium.Math.toRadians(-20.0);
				hpRange.heading = heading;
				hpRange.pitch = pitch;
				hpRange.range = r * 50.0;
				camera.lookAt(center, hpRange);
			});

			document.addEventListener('keydown', function(e) {
				switch (e.keyCode) {
					case 40:
						if (e.shiftKey) {
							//减速
							speed = Math.max(--speed, 1);
						} else {
							//俯冲
							hpRoll.pitch -= deltaRadians;
							if (hpRoll.pitch < -Cesium.Math.TWO_PI) {
								hpRoll.pitch += Cesium.Math.TWO_PI;
							}
						}
						break;
					case 38:
						if (e.shiftKey) {
							//加速
							speed = Math.min(++speed, 100);
						} else {
							//上仰
							hpRoll.pitch += deltaRadians;
							if (hpRoll.pitch > Cesium.Math.TWO_PI) {
								hpRoll.pitch -= Cesium.Math.TWO_PI;
							}
						}
						break;
					case 39:
						if (e.shiftKey) {
							//向右侧翻滚
							hpRoll.roll += deltaRadians;
							if (hpRoll.roll > Cesium.Math.TWO_PI) {
								hpRoll.roll -= Cesium.Math.TWO_PI;
							}
						} else {
							//向右转
							hpRoll.heading += deltaRadians;
							if (hpRoll.heading > Cesium.Math.TWO_PI) {
								hpRoll.heading -= Cesium.Math.TWO_PI;
							}
						}
						break;
					case 37:
						if (e.shiftKey) {
							//向左侧翻滚
							hpRoll.roll -= deltaRadians;
							if (hpRoll.roll < 0.0) {
								hpRoll.roll += Cesium.Math.TWO_PI;
							}
						} else {
							//向左转
							hpRoll.heading -= deltaRadians;
							if (hpRoll.heading < 0.0) {
								hpRoll.heading += Cesium.Math.TWO_PI;
							}
						}
						break;
					default:
				}
			});

			var headingSpan = document.getElementById('heading');
			var pitchSpan = document.getElementById('pitch');
			var rollSpan = document.getElementById('roll');
			var speedSpan = document.getElementById('speed');
			var fromBehind = document.getElementById('fromBehind');

			viewer.scene.preUpdate.addEventListener(function(scene, time) {
				speedVector = Cesium.Cartesian3.multiplyByScalar(Cesium.Cartesian3.UNIT_X, speed / 10, speedVector);
				position = Cesium.Matrix4.multiplyByPoint(planePrimitive.modelMatrix, speedVector, position);
				pathPosition.addSample(Cesium.JulianDate.now(), position);
				Cesium.Transforms.headingPitchRollToFixedFrame(position, hpRoll, Cesium.Ellipsoid.WGS84, fixedFrameTransform,
					planePrimitive.modelMatrix);

				if (fromBehind.checked) {
					// Zoom to model
					Cesium.Matrix4.multiplyByPoint(planePrimitive.modelMatrix, planePrimitive.boundingSphere.center, center);
					hpRange.heading = hpRoll.heading;
					hpRange.pitch = hpRoll.pitch;
					camera.lookAt(center, hpRange);
				}
			});

			viewer.scene.preRender.addEventListener(function(scene, time) {
				headingSpan.innerHTML = Cesium.Math.toDegrees(hpRoll.heading).toFixed(1);
				pitchSpan.innerHTML = Cesium.Math.toDegrees(hpRoll.pitch).toFixed(1);
				rollSpan.innerHTML = Cesium.Math.toDegrees(hpRoll.roll).toFixed(1);
				speedSpan.innerHTML = speed.toFixed(1);
			});
		</script>
	</body>
</html>
